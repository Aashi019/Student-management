{% extends 'base.html' %}

{% block title %}Fee Management - Admin{% endblock %}
{% block page_title %}Fee Management{% endblock %}

{% block content %}
<div class="content animate-fade-in-up">
    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-body">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">₨{{ "{:,.0f}".format(total_fees_defined) }}</h3>
                <p style="margin: 0; opacity: 0.9;">Total Fees Defined</p>
            </div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white;">
            <div class="card-body">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">₨{{ "{:,.0f}".format(total_payments) }}</h3>
                <p style="margin: 0; opacity: 0.9;">Total Payments Received</p>
            </div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white;">
            <div class="card-body">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">₨{{ "{:,.0f}".format(pending_payments) }}</h3>
                <p style="margin: 0; opacity: 0.9;">Pending Payments</p>
            </div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
            <div class="card-body">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">{{ fee_structures|length }}</h3>
                <p style="margin: 0; opacity: 0.9;">Fee Structures</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    {% if not is_teacher_view %}
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">Quick Actions</h2>
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="{{ url_for('add_fee_structure') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Fee Structure
                </a>
                <a href="{{ url_for('add_fee_payment') }}" class="btn btn-success">
                    <i class="fas fa-money-bill"></i> Record Payment</a>
                </a>
                <a href="{{ url_for('fee_reports') }}" class="btn btn-secondary">
                    <i class="fas fa-chart-bar"></i> View Reports
                </a>
                <button onclick="exportAllFeeData()" class="btn btn-secondary">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Fee Structures -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">Fee Structures</h2>
        </div>
        <div class="card-body">
            {% if fee_structures %}
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fee Name</th>
                                <th>Faculty</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Status</th>
                                {% if not is_teacher_view %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for fee_structure in fee_structures %}
                            <tr>
                                <td>
                                    <strong>{{ fee_structure.name }}</strong>
                                    {% if fee_structure.description %}
                                        <br><small style="color: var(--text-secondary);">{{ fee_structure.description }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ fee_structure.faculty.name if fee_structure.faculty else 'All Faculties' }}</td>
                                <td>₨{{ "{:,.0f}".format(fee_structure.amount) }}</td>
                                <td>
                                    <span class="fee-type-badge fee-type-{{ fee_structure.fee_type }}">
                                        {{ fee_structure.fee_type.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ 'active' if fee_structure.is_active else 'inactive' }}">
                                        {{ 'Active' if fee_structure.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                {% if not is_teacher_view %}
                                <td>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="editFeeStructure({{ fee_structure.id }})" class="btn btn-secondary btn-sm" title="Edit Fee Structure">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="toggleFeeStructure({{ fee_structure.id }})" class="btn btn-{{ 'warning' if fee_structure.is_active else 'success' }} btn-sm" title="{{ 'Deactivate' if fee_structure.is_active else 'Activate' }} Fee Structure">
                                            <i class="fas fa-{{ 'pause' if fee_structure.is_active else 'play' }}"></i>
                                        </button>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <i class="fas fa-money-bill" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                    <h3>No Fee Structures</h3>
                    <p>Start by creating fee structures for different faculties and semesters.</p>
                    <a href="{{ url_for('add_fee_structure') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add First Fee Structure
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Payments -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Recent Payments</h2>
        </div>
        <div class="card-body">
            {% if recent_payments %}
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Fee Type</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Receipt No.</th>
                                <th>Status</th>
                                {% if not is_teacher_view %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>{{ payment.payment_date.strftime('%d %b %Y') }}</td>
                                <td>
                                    <div>
                                        <div style="font-weight: 500;">{{ payment.student.first_name }} {{ payment.student.last_name }}</div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">{{ payment.student.student_id }}</div>
                                    </div>
                                </td>
                                <td>{{ payment.fee_structure.name }}</td>
                                <td>₨{{ "{:,.0f}".format(payment.amount_paid) }}</td>
                                <td>{{ payment.payment_method.title().replace('_', ' ') if payment.payment_method else 'N/A' }}</td>
                                <td><code>{{ payment.receipt_number }}</code></td>
                                <td><span class="status-badge status-{{ payment.payment_status }}">{{ payment.payment_status.title() }}</span></td>
                                {% if not is_teacher_view %}
                                <td>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="viewPaymentDetails({{ payment.id }})" class="btn btn-secondary btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="printReceipt({{ payment.id }})" class="btn btn-secondary btn-sm">
                                            <i class="fas fa-print"></i>
                                        </button>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                    <p>No recent payments found.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.fee-type-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.fee-type-semester {
    background: #e0e7ff;
    color: #3730a3;
}

.fee-type-annual {
    background: #fef3c7;
    color: #92400e;
}

.fee-type-monthly {
    background: #ecfdf5;
    color: #065f46;
}

.fee-type-one-time {
    background: #fce7f3;
    color: #9d174d;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th,
.table td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--gray-200);
    text-align: left;
    vertical-align: middle;
}

.table th {
    font-weight: 600;
    background: var(--gray-50);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}
</style>

<script>
function editFeeStructure(feeStructureId) {
    window.location.href = '/fees/structure/edit/' + feeStructureId;
}

function toggleFeeStructure(feeStructureId) {
    if (confirm('Are you sure you want to toggle the status of this fee structure?')) {
        window.location.href = '/fees/structure/toggle/' + feeStructureId;
    }
}

function viewPaymentDetails(paymentId) {
    alert('Payment Details\n\nPayment ID: ' + paymentId + '\n\nThis would show detailed payment information in a modal.');
}

function printReceipt(paymentId) {
    alert('Print Receipt\n\nPayment ID: ' + paymentId + '\n\nThis would generate and print a receipt for this payment.');
}

function exportAllFeeData() {
    if (confirm('Export all fee data? This may take a moment for large datasets.')) {
        window.location.href = '{{ url_for("export_fee_data", export_type="csv") }}';
    }
}
</script>
{% endblock %}